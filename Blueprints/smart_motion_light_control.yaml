blueprint:
  name: "Smarte Lichtsteuerung bei Bewegung"
  description: "Schaltet das Licht basierend auf Bewegung und Lichtverhältnissen ein."
  domain: automation
  input:
    light_switch:
      name: "Licht"
      description: "Licht, das gesteuert werden soll"
      selector:
        entity:
          domain: switch
          multiple: true
    motion_sensors:
      name: "Bewegungssensoren"
      description: "Liste der Bewegungssensoren"
      selector:
        entity:
          domain: binary_sensor
          multiple: true
    lux_sensor:
      name: "Helligkeitssensor"
      description: "Sensor für die Umgebungshelligkeit"
      selector:
        entity:
          domain: sensor
    lux_threshold:
      name: "Helligkeitsgrenze"
      description: "Ab welcher Helligkeit (in Lux) das Licht nicht mehr angeht"
      default: 2000
      selector:
        number:
          min: 0
          max: 10000
          step: 10
          unit_of_measurement: "lx"
    light_mode:
      name: "Licht-Modus"
      description: "Entity, welche den Licht-Modus ('immer an', 'immer aus', 'auto') angibt."
      selector:
        entity:
          domain: input_select
    on_state:
      name: "Modus für 'immer-an'"
      description: "Definiere den Status für den 'immer-an' Modus"
      selector:
        text: {}
      default: "on"
    off_state:
      name: "Modus für 'immer-aus'"
      description: "Definiere den Status für den 'immer-aus' Modus"
      selector:
        text: {}
      default: "off"
    auto_state:
      name: "Modus für 'auto'"
      description: "Definiere den Status für den 'auto' Modus"
      selector:
        text: {}
      default: "auto"
    off_timer:
      name: "Zeit bis Ausschalten (Sekunden)"
      description: "Dauer, nach der das Licht ausgeschaltet wird, falls keine Bewegung erkannt wird."
      default: 30
      selector:
        number:
          min: 10
          max: 600
          step: 5
          unit_of_measurement: "s"

mode: queued
max: 10

trigger:
  - platform: state
    entity_id: !input motion_sensors
    to: "on"
  - platform: state
    entity_id: timer.bewegung_licht_timer
    to: "idle"
  - platform: state
    entity_id: !input light_mode

condition: []

action:
  - choose:
      - conditions:
          - condition: state
            entity_id: !input light_mode
            state: !input on_state
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input light_switch

      - conditions:
          - condition: state
            entity_id: !input light_mode
            state: !input auto_state
          - condition: numeric_state
            entity_id: !input lux_sensor
            below: !input lux_threshold
          - condition: state
            entity_id: !input motion_sensors
            state: "on"
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input light_switch
          - service: timer.start
            target:
              entity_id: timer.bewegung_licht_timer
            data:
              duration: !input off_timer

  - choose:
      - conditions:
          - condition: state
            entity_id: !input light_mode
            state: !input off_state
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input light_switch
      - conditions:
          - condition: state
            entity_id: timer.bewegung_licht_timer
            state: "idle"
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input light_switch